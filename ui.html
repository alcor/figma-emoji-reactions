<style>
  body {margin:10px 0px }
  * {font-family: sans-serif}

  footer {
    position:fixed;
    bottom:0;
    left:0;
    right:0;

    border-top:1px solid #eee;
    background:#fafafa;
  }

  .tabs {
    display:flex;
    justify-content: space-between;
    margin: 0 0;
  }

  .tab {
    width:44px; height:44px;
    content:"x";
    display:inline-block;
  }

  .spacer {
    width:auto; height:44px;
    display:inline-block;
    flex-grow: 10;
  }

  .colors {
    display:flex;
    justify-content: start;
    margin: 0 0;
    margin-bottom:1em;
  }

  .color-button {
    width:25px; height:25px;
    box-shadow: inset 0px -1px 0.5px 1px rgba(0,0,0,0.1);
    margin-right:8px;
    display:inline-block;
    border-radius:999px;
  }

  .content {
    display:none;
    padding:0 1em;
    flex-direction: column;
  }

  .tab {
    background-position: center;
    background-size:32px;
    background-repeat: no-repeat;
  }

  .tab#emoji { 
    background-image: url("data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='4.5' y='4.5' width='23' height='23' rx='11.5' fill='%23F3F3F3' stroke='black'/%3E%3Cline x1='13.5' y1='11' x2='13.5' y2='17' stroke='black'/%3E%3Cline x1='18.5' y1='11' x2='18.5' y2='17' stroke='black'/%3E%3C/svg%3E%0A");
  }
  .tab#bubble { 
    background-image: url("data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M16 27.5H4.5V16C4.5 9.64873 9.64873 4.5 16 4.5C22.3513 4.5 27.5 9.64873 27.5 16C27.5 22.3513 22.3513 27.5 16 27.5Z' fill='%23F3F3F3' stroke='black'/%3E%3C/svg%3E%0A");
  }
  .tab#sticky { 
    background-image: url("data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cmask id='path-1-inside-1' fill='white'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M28 4H4V28H21L28 21V4Z'/%3E%3C/mask%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M28 4H4V28H21L28 21V4Z' fill='%23F3F3F3'/%3E%3Cpath d='M4 4V3H3V4H4ZM28 4H29V3H28V4ZM4 28H3V29H4V28ZM21 28V29H21.4142L21.7071 28.7071L21 28ZM28 21L28.7071 21.7071L29 21.4142V21H28ZM4 5H28V3H4V5ZM5 28V4H3V28H5ZM21 27H4V29H21V27ZM21.7071 28.7071L28.7071 21.7071L27.2929 20.2929L20.2929 27.2929L21.7071 28.7071ZM27 4V21H29V4H27Z' fill='black' mask='url(%23path-1-inside-1)'/%3E%3Cpath d='M21 27.2929L21 21L27.2929 21L21 27.2929Z' stroke='black' stroke-linejoin='round'/%3E%3C/svg%3E%0A");
  }

  .tab#meme { 
    background-image: url("data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='3.5' y='5.5' width='25' height='21' fill='%23F3F3F3' stroke='black'/%3E%3Cmask id='path-2-inside-1' fill='white'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M12.6171 12.1216L10 11V13.9232C9.36518 14.6757 9 15.5574 9 16.5C9 19.2614 12.134 21.5 16 21.5C19.866 21.5 23 19.2614 23 16.5C23 15.5574 22.6348 14.6757 22 13.9232V11L19.1975 12.0509C18.239 11.6988 17.152 11.5 16 11.5C14.773 11.5 13.6198 11.7255 12.6171 12.1216Z'/%3E%3C/mask%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M12.6171 12.1216L10 11V13.9232C9.36518 14.6757 9 15.5574 9 16.5C9 19.2614 12.134 21.5 16 21.5C19.866 21.5 23 19.2614 23 16.5C23 15.5574 22.6348 14.6757 22 13.9232V11L19.1975 12.0509C18.239 11.6988 17.152 11.5 16 11.5C14.773 11.5 13.6198 11.7255 12.6171 12.1216Z' fill='white'/%3E%3Cpath d='M10 11L10.3939 10.0809L9 9.48346V11H10ZM12.6171 12.1216L12.2232 13.0407L12.6016 13.2029L12.9845 13.0517L12.6171 12.1216ZM10 13.9232L10.7644 14.5679L11 14.2886V13.9232H10ZM22 13.9232H21V14.2886L21.2356 14.5679L22 13.9232ZM22 11H23V9.557L21.6489 10.0637L22 11ZM19.1975 12.0509L18.8526 12.9896L19.2011 13.1176L19.5486 12.9873L19.1975 12.0509ZM9.60608 11.9191L12.2232 13.0407L13.011 11.2025L10.3939 10.0809L9.60608 11.9191ZM11 13.9232V11H9V13.9232H11ZM10 16.5C10 15.8284 10.2575 15.1688 10.7644 14.5679L9.23564 13.2784C8.47288 14.1826 8 15.2863 8 16.5H10ZM16 20.5C14.2514 20.5 12.7101 19.9922 11.6315 19.2218C10.551 18.45 10 17.4739 10 16.5H8C8 18.2875 9.01603 19.8114 10.469 20.8493C11.9239 21.8885 13.8826 22.5 16 22.5V20.5ZM22 16.5C22 17.4739 21.449 18.45 20.3685 19.2218C19.2899 19.9922 17.7486 20.5 16 20.5V22.5C18.1174 22.5 20.0761 21.8885 21.531 20.8493C22.984 19.8114 24 18.2875 24 16.5H22ZM21.2356 14.5679C21.7425 15.1688 22 15.8284 22 16.5H24C24 15.2863 23.5271 14.1826 22.7644 13.2784L21.2356 14.5679ZM23 13.9232V11H21V13.9232H23ZM21.6489 10.0637L18.8464 11.1146L19.5486 12.9873L22.3511 11.9363L21.6489 10.0637ZM16 12.5C17.0382 12.5 18.0082 12.6793 18.8526 12.9896L19.5424 11.1123C18.4699 10.7182 17.2658 10.5 16 10.5V12.5ZM12.9845 13.0517C13.8659 12.7035 14.894 12.5 16 12.5V10.5C14.652 10.5 13.3737 10.7475 12.2497 11.1915L12.9845 13.0517Z' fill='black' mask='url(%23path-2-inside-1)'/%3E%3Cline x1='17.5' y1='15' x2='17.5' y2='16' stroke='black'/%3E%3Cpath d='M17 17H15L16 18L17 17Z' fill='black'/%3E%3Cline x1='14.5' y1='15' x2='14.5' y2='16' stroke='black'/%3E%3C/svg%3E%0A");
  }

  .tab#settings {
    background-image: url("data:image/svg+xml,%3Csvg width='32' height='32' viewBox='0 0 32 32' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M28.3096 20.1993L28.3097 20.1993L28.3145 20.1908C28.4411 19.9683 28.5312 19.7031 28.4899 19.4206C28.4468 19.1259 28.2748 18.9042 28.0599 18.7514L25.6968 16.9559C25.7177 16.6942 25.7271 16.3737 25.7271 16C25.7271 15.6263 25.7177 15.3058 25.6968 15.0441L28.0599 13.2486C28.2748 13.0958 28.4468 12.8741 28.4899 12.5794C28.5312 12.2969 28.4411 12.0317 28.3145 11.8092L28.3146 11.8091L28.3096 11.8007L25.8317 7.63487C25.8314 7.63434 25.8311 7.63381 25.8307 7.63328C25.7014 7.41294 25.5066 7.23474 25.2413 7.15497C24.9871 7.07856 24.7284 7.11071 24.4956 7.18654L24.4826 7.19076L24.4699 7.19569L21.6674 8.28046C21.1278 7.8991 20.5626 7.57631 19.9721 7.31276L19.5512 4.4347L19.5484 4.41528L19.544 4.39614C19.4904 4.1603 19.3836 3.92603 19.1848 3.75126C18.9798 3.57102 18.7294 3.5 18.4798 3.5H13.5202C13.2706 3.5 13.0202 3.57102 12.8152 3.75126C12.6164 3.92603 12.5096 4.1603 12.456 4.39614L12.4516 4.41528L12.4488 4.4347L12.0283 7.31049C11.5235 7.53659 10.96 7.86357 10.3403 8.28346L7.53011 7.19569L7.5174 7.19076L7.50444 7.18654C7.27156 7.11071 7.01293 7.07856 6.75875 7.15497C6.49344 7.23472 6.29869 7.41284 6.16937 7.6331L3.69042 11.8007L3.69034 11.8007L3.68551 11.8092C3.55893 12.0317 3.46876 12.2969 3.51007 12.5794C3.55316 12.8741 3.72516 13.0958 3.94007 13.2486L6.30319 15.0441C6.28235 15.3058 6.27293 15.6263 6.27293 16C6.27293 16.3737 6.28235 16.6942 6.30319 16.9559L3.94009 18.7514C3.72517 18.9042 3.55316 19.1259 3.51007 19.4206C3.46876 19.7031 3.55893 19.9683 3.68551 20.1908L3.68543 20.1909L3.69042 20.1993L6.16833 24.3651C6.16868 24.3657 6.16902 24.3663 6.16937 24.3669C6.29869 24.5872 6.49344 24.7653 6.75875 24.845C7.01293 24.9214 7.27156 24.8893 7.50444 24.8135L7.5174 24.8092L7.53011 24.8043L10.3326 23.7195C10.8722 24.1009 11.4374 24.4237 12.0279 24.6872L12.4488 27.5653L12.4516 27.5847L12.456 27.6039C12.5096 27.8397 12.6164 28.074 12.8152 28.2487C13.0202 28.429 13.2706 28.5 13.5202 28.5H18.4798C18.7294 28.5 18.9798 28.429 19.1848 28.2487C19.3836 28.074 19.4904 27.8397 19.544 27.6039L19.5484 27.5847L19.5512 27.5653L19.9717 24.6895C20.4765 24.4634 21.04 24.1364 21.6597 23.7165L24.4699 24.8043L24.4826 24.8092L24.4956 24.8135C24.7284 24.8893 24.9871 24.9214 25.2413 24.845C25.5066 24.7653 25.7014 24.5871 25.8307 24.3667C25.8311 24.3662 25.8314 24.3657 25.8317 24.3651L28.3096 20.1993ZM16 19.7254C14.9376 19.7254 14.0445 19.3625 13.2929 18.6283C12.5417 17.8944 12.1748 17.0273 12.1748 16C12.1748 14.9727 12.5417 14.1056 13.2929 13.3717C14.0445 12.6375 14.9376 12.2746 16 12.2746C17.0624 12.2746 17.9555 12.6375 18.7071 13.3717C19.4583 14.1056 19.8252 14.9727 19.8252 16C19.8252 17.0273 19.4583 17.8944 18.7071 18.6283C17.9555 19.3625 17.0624 19.7254 16 19.7254Z' fill='%23F3F3F3' stroke='black'/%3E%3C/svg%3E%0A");
  }

  body.emoji .tab#emoji,
  body.bubble .tab#bubble,
  body.sticky .tab#sticky,
  body.meme .tab#meme,
  body.settings .tab#settings {
    background-color:#f1f1f1;
  }

  body.bubble #message-content.content,
  body.sticky #message-content.content,
  body.bubble #color-content.content,
  body.sticky #color-content.content,
  body.meme #meme-content.content,
  body.settings #settings-content.content {
    display:flex;
  }

  #message-content {
    width:auto;
    height: auto;
    position:relative;
    transition: background-color 100ms, min-height 100ms, border-radius 100ms;
  }

  body.sticky #message-content {
    background-color:#FCF3C4;
    min-height:128px;
    margin:0 1em;
    display:flex;
    align-items: center;
    justify-content: center;
  }

  body.bubble #message-content {
    background-color:#f1f1f1;
    height:3em;
    margin:0 1em;
    min-height:64px;
    border-radius: 24px 24px 24px 0;
    display:flex;
    align-items: center;
    justify-content: center;
  }

  body.sticky #message-content:before {
    content:"";
    position:absolute;
    bottom:0;
    right:0;
    border-width:0 0 30px 30px;
    border-style:solid;
    border-color:rgba(0,0,0,0.1) white white rgba(0,0,0,0.1);
  }


  #message:focus {
    outline: none;
  }

  #message {
    font-size:16pt;
    width:100%;
    height:40px;
    box-sizing: border-box;
    padding:8px;
    margin:8px;
    border:none;
    background:none;
  }

  body.emoji #emoji-content.content {
    display:flex;
    flex-flow: row wrap;
    padding:0em;
  }
  
  .emoji-button {
    font-size:30px;
    line-height:2em;
    text-align:center;
    display: inline-block;
    width:60px;
    cursor: pointer;
    display: inline-block;
    transform: translateZ(0);
    box-shadow: 0 0 1px rgba(0, 0, 0, 0);
    backface-visibility: hidden;
    -moz-osx-font-smoothing: grayscale;
    transition-duration: 0.3s;
    transition-property: all;
  }
  .emoji-button:hover,
  .emoji-button:focus {
    background-color:#eee;
    /* transform: scale(1.1); */
  }
  .emoji-button:active {
    background-color: rgba(255, 255, 255, 0);
    transition-delay: .5s;
    transition-duration: 3s;
    transform: scale(2.25);
    animation-name: emoji-shake;
  }
  @keyframes emoji-shake {
  16.65% {
    -webkit-transform: translateX(12px);
    transform: translateX(12px);
  }
  33.3% {
    -webkit-transform: translateX(-10px);
    transform: translateX(-10px);
  }
  49.95% {
    -webkit-transform: translateX(8px);
    transform: translateX(8px);
  }
  66.6% {
    -webkit-transform: translateX(-5px);
    transform: translateX(-5px);
  }
  83.25% {
    -webkit-transform: translateX(2px);
    transform: translateX(2px);
  }
  100% {
    -webkit-transform: translateX(0);
    transform: translateX(0);
  }
}

  #meme-content input {
    margin-bottom:8px;
  }

</style>

<footer>
  <div class="tabs">
    <span class="tab" id="emoji" onclick="select(this)"></span>
    <span class="tab" id="bubble" onclick="select(this)"></span>
    <span class="tab" id="sticky" onclick="select(this)"></span>
    <!--<span class="tab" id="meme" onclick="select(this)"></span>-->
    <span class="spacer"></span>
    <span class="tab" id="settings" onclick="select(this)"></span>
  </div> 
</footer>


<div class="content" id="emoji-content">
  <span class="emoji-button">⭐</span>
  <span class="emoji-button">👍</span>
  <span class="emoji-button">👎️</span>
  <span class="emoji-button">&#10084;&#65039;</span>
  <span class="emoji-button">🔥</span>  

  <span class="emoji-button">🙂</span>
  <span class="emoji-button">🧐</span>
  <span class="emoji-button">😞</span>
  <span class="emoji-button">🚫</span>
  <span class="emoji-button">❗️</span>


  <span class="emoji-button">😍</span>
  <span class="emoji-button">😮</span>
  <span class="emoji-button">😬</span>
  <span class="emoji-button">📍</span>
  <span class="emoji-button">✅</span>
</div>

<div class="content" id="color-content">                 
  <div class="colors">
    <div class="color-button" style="background-color:#ffffff; border: 1px solid black;"></div>
    <div class="color-button" style="background-color:#EEEDEC"></div>
    <div class="color-button" style="background-color:#FCE8E9"></div>
    <div class="color-button" style="background-color:#FFE7CA"></div>
    <div class="color-button" style="background-color:#FCF3C4"></div>
    <div class="color-button" style="background-color:#ECF5E5"></div>
    <div class="color-button" style="background-color:#E1F5FF"></div>
    <div class="color-button" style="background-color:#EBE4F3"></div>
  </div>
</div>

<div class="content" id="message-content">                 
  <input id="message" placeholder="Message Content">
</div>

<div class="content" id="meme-content">
  <label for="name">Type</label> 
  <input id="meme-type" placeholder="meme type">
  <label for="name">Top Text</label> 
  <input id="meme-top-text" placeholder="top text">
  <label for="name">Bottom Text</label> 
  <input id="meme-bottom-text" placeholder="bottom text">
  <button id="temporary-meme-button">Place meme</button>
</div>

<div class="content" id="settings-content">
  <label for="name">Name:</label> 
  <input id="name" placeholder="Your Name">
</div>
                    

<script>
document.body.className = "bubble";

var settings = {
  tab:"emoji",
  bubbleColor:"white",
  stickyColor:"#FCF3C4",
  name:""
}

function select(i) {
  console.log(i.id);
  settings.tab = i.id;
  saveSettings();
  document.body.className = i.id;
  textbox.focus()
}

function saveSettings() {
  parent.postMessage({pluginMessage: {type: "settings", settings}}, '*')
  applyColors();
}

function applyColors() {
  if (settings.tab === "bubble") {
    document.getElementById("message-content").style.backgroundColor = settings.bubbleColor;
  } else if (settings.tab === "sticky") {
    document.getElementById("message-content").style.backgroundColor = settings.stickyColor;
  }
}

document.body.onclick = function(e){
  var el = window.event ? event.srcElement : e.target;
  if (el.className && el.className.indexOf('emoji-button')!=-1) {
    // var string = el.textContent
    // var altPressed = e.altKey
    // parent.postMessage({pluginMessage: {type: "add-emoji", content: string, altPressed, settings}}, '*')      
  } else if (el.className && el.className.indexOf('color-button')!=-1) {
    var color = el.style.backgroundColor;
    if (settings.tab === "bubble") {
      settings.bubbleColor = color;
    } else if (settings.tab === "sticky") {
      settings.stickyColor = color;
    }
    saveSettings();
    textbox.focus()
  }
}

document.body.onmousedown = (e) => {
  var el = window.event ? event.srcElement : e.target;
  if (el.className && el.className.indexOf('emoji-button')!=-1) {
    var string = el.textContent
    var altPressed = e.altKey
    parent.postMessage({pluginMessage: {type: "add-emoji", content: string, altPressed, settings}}, '*')  
  }
}

document.body.onmouseup = (e) => {
  var el = window.event ? event.srcElement : e.target;
  if (el.className && el.className.indexOf('emoji-button')!=-1) {
    var string = el.textContent
    var altPressed = e.altKey
    parent.postMessage({pluginMessage: {type: "emoji-mouseup", content: string, altPressed, settings}}, '*')  
  }
}


// var mouseDownTimer
// var reactStartPress
// var reactEndPress
// var reactHoldTime
// var reactionScale = 1
// const emojiButtons = document.querySelectorAll(".emoji-button")
// for (let btn of emojiButtons) {
//   btn.addEventListener("mousedown", (e) => {
//     var string = el.textContent;
//     var altPressed = e.altKey
//     parent.postMessage({pluginMessage: {type: "add-emoji", content: string, altPressed, settings, reactionScale}}, '*')  
//     reactStartPress = new Date()    
//     mouseDownTimer = setInterval(() => {
//       console.log("down")    
//     }, 25)
//   })
//   btn.addEventListener("mouseup", (e) => {
//     reactEndPress = new Date()
//     reactHoldTime = (reactEndPress - reactStartPress) / 1000
//     reactionScale = timeToScale(reactHoldTime)
//     parent.postMessage({pluginMessage: {type: "commit-emoji"}}, "*")
//     clearInterval(mouseDownTimer)
//   })
// }
timeToScale = (time) => {
  if (time < 0.5) {
    time = 1
  } else if (time > 3) {
    time = 3
  }
  return time
}


const textbox = document.getElementById('message');
textbox.focus()

textbox.addEventListener("keyup", function(event) {
  if (event.keyCode === 13) {
    console.log(document.body.className)
    var altPressed = event.altKey
    event.preventDefault();
    const string = textbox.value;
    switch (document.body.className) {
      case "sticky":
        parent.postMessage({pluginMessage: {type: "add-sticky", content: string, color:settings.stickyColor, settings}}, '*')
        break; 
      default:
        parent.postMessage({ pluginMessage: { type: 'add-bubble', string,  color:settings.bubbleColor, settings} }, '*')
    }
  } else if(event.key === "Escape") {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
  }
});

/*
  NO MEMES (FOR NOW?)
*/
// const tempMemeButton = document.getElementById("temporary-meme-button");
// tempMemeButton.addEventListener("click",(e) => {
//   const memeType = document.getElementById('meme-type').value;
//   const topText = document.getElementById('meme-top-text').value;
//   const bottomText = document.getElementById('meme-bottom-text').value;
//   parent.postMessage({pluginMessage: {type: "add-meme", memeType: memeType, topText: topText, bottomText: bottomText, settings}}, '*')
// })

// image fetching only works in the UI for some reason
onmessage = (e) => {
  let message = event.data.pluginMessage;
  if (message.type === 'getImageData') {
      let url = e.data.pluginMessage.url
      fetch(url)
        .then(r => r.arrayBuffer())
        .then(a => parent.postMessage({ pluginMessage: {type: 'image-data-received', data: new Uint8Array(a), settings}}, '*'))
        .catch(err => console.error({ err }))
  } else if (message.type === 'settings') {
    settings = message.settings;
    applyColors()
    document.body.className = message.settings.tab;
  }
}

// big reaccs
// var reactStartPress
// var reactEndPress
// var reactHoldTime
// var reactionScale = 1
// const emojiButtons = document.querySelectorAll(".emoji-button")
// for (let btn of emojiButtons) {
//   btn.addEventListener("mousedown", (e) => {
//     reactStartPress = new Date()
//   })
//   btn.addEventListener("mouseup", (e) => {
//     reactEndPress = new Date()
//     reactHoldTime = (reactEndPress - reactStartPress) / 1000
//     reactionScale = timeToScale(reactHoldTime)
//   })
// }
// timeToScale = (time) => {
//   if (time < 0.5) {
//     time = 1
//   } else if (time > 3) {
//     time = 3
//   }
//   return time
// }

</script>
